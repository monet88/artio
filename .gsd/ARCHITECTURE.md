# Architecture

> Auto-generated by /map on 2026-02-19 (updated 2026-02-21T00:57)

## Overview

**Artio** is an AI-powered art generation mobile app built with Flutter and backed by Supabase. Users browse curated prompt templates, customize parameters, generate images via AI APIs (KIE.ai and Google Gemini), and manage their personal gallery. The app uses a **freemium credit system** â€” users spend credits per generation, earn credits via rewarded ads, and can subscribe for monthly credit allowances via RevenueCat. The project is a monorepo containing both the **mobile client app** and a **web admin dashboard**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flutter Mobile App (artio/)              â”‚
â”‚  Splash â†’ Auth â†’ Shell (Home / Create / Gallery / Settings)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          Feature Modules (Clean Architecture)        â”‚
â”‚  auth â€¢ template_engine â€¢ create â€¢ credits â€¢         â”‚
â”‚  subscription â€¢ gallery â€¢ settings                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Core Layer (Config, Providers, Design System)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Supabase (Auth + DB + Storage)           â”‚
â”‚              Edge Functions (generate-image,          â”‚
â”‚                reward-ad, revenuecat-webhook)         â”‚
â”‚              AI Providers (KIE.ai + Gemini)           â”‚
â”‚              RevenueCat (In-App Purchases)            â”‚
â”‚              Google AdMob (Rewarded Ads)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Flutter Web Admin (admin/)                  â”‚
â”‚  Auth â†’ Shell (Dashboard / Templates)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Project Structure

```
artio/
â”œâ”€â”€ lib/                      # Main app source code (194 files total: 145 source + 49 generated, ~13,248 LoC)
â”‚   â”œâ”€â”€ main.dart             # Entry point, Supabase init, RevenueCat init, Sentry
â”‚   â”œâ”€â”€ core/                 # Shared infrastructure (29 files)
â”‚   â”‚   â”œâ”€â”€ config/           # EnvConfig, SentryConfig
â”‚   â”‚   â”œâ”€â”€ constants/        # AiModels, AppConstants (credits, ads, generation), GenerationConstants
â”‚   â”‚   â”œâ”€â”€ design_system/    # Animations, Dimensions, Gradients, Shadows, Spacing, Typography
â”‚   â”‚   â”œâ”€â”€ exceptions/       # AppException (freezed: network, auth, storage, payment, generation, unknown)
â”‚   â”‚   â”œâ”€â”€ providers/        # Connectivity, Supabase providers
â”‚   â”‚   â”œâ”€â”€ services/         # HapticService, RewardedAdService (Google AdMob)
â”‚   â”‚   â”œâ”€â”€ state/            # UserScopedProviders
â”‚   â”‚   â””â”€â”€ utils/            # AppExceptionMapper, EmailValidator, Retry, DateTimeUtils, WatermarkUtil
â”‚   â”œâ”€â”€ features/             # Feature modules (7 features, Clean Architecture)
â”‚   â”‚   â”œâ”€â”€ auth/             # Authentication (data/domain/presentation) â€” 16 files
â”‚   â”‚   â”œâ”€â”€ template_engine/  # Template browsing & detail (data/domain/presentation) â€” 44 files
â”‚   â”‚   â”œâ”€â”€ create/           # Text-to-image generation (domain/presentation) â€” 13 files
â”‚   â”‚   â”œâ”€â”€ credits/          # Credit system & ad rewards (data/domain/presentation) â€” 16 files
â”‚   â”‚   â”œâ”€â”€ subscription/     # RevenueCat subscriptions (data/domain/presentation) â€” 13 files
â”‚   â”‚   â”œâ”€â”€ gallery/          # User image gallery (data/domain/presentation) â€” 26 files
â”‚   â”‚   â””â”€â”€ settings/         # App settings (data/domain/presentation) â€” 9 files
â”‚   â”œâ”€â”€ routing/              # GoRouter with type-safe routes
â”‚   â”œâ”€â”€ shared/widgets/       # 15 reusable widgets
â”‚   â”œâ”€â”€ theme/                # AppTheme, AppColors, ThemeProvider
â”‚   â””â”€â”€ utils/                # LoggerService
â”œâ”€â”€ admin/                    # Admin dashboard (separate Flutter web app)
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ core/             # Router, theme, constants, utils, shell
â”‚       â”œâ”€â”€ features/         # auth, dashboard, templates
â”‚       â””â”€â”€ shared/           # Shared admin widgets
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/           # 9 SQL migrations
â”‚   â””â”€â”€ functions/
â”‚       â”œâ”€â”€ _shared/          # Shared Deno modules (cors, model_config, credit_logic) + tests
â”‚       â”œâ”€â”€ deno.json         # Deno CI tasks: `deno task check` (5 files) + `deno task test`
â”‚       â”œâ”€â”€ generate-image/   # Deno Edge Function â€” AI image generation orchestrator
â”‚       â”œâ”€â”€ reward-ad/        # Deno Edge Function â€” rewarded ad credit granting
â”‚       â””â”€â”€ revenuecat-webhook/ # Deno Edge Function â€” subscription lifecycle webhook
â”œâ”€â”€ test/                     # 76 unit + widget test files (mirrors lib/ structure)
â”œâ”€â”€ integration_test/         # 5 E2E tests (auth, gallery, generation, settings, template)
â”œâ”€â”€ docs/                     # Project docs, KIE API docs, architecture
â”œâ”€â”€ scripts/                  # Validation & search scripts (PowerShell + Bash)
â””â”€â”€ android/ ios/ web/ windows/  # Platform shells
```

---

## Components

### 1. Auth Feature (`lib/features/auth/`) â€” 16 files
- **Purpose:** User registration, login, password reset, session management
- **Architecture:** data/domain/presentation (Clean Architecture)
- **Domain entities:** `UserModel` (freezed)
- **Data layer:** `AuthRepository` (Supabase Auth)
- **Presentation:** `AuthViewModel` (Riverpod), `SplashScreen`, `LoginScreen`, `RegisterScreen`, `ForgotPasswordScreen`
- **Key behavior:** AuthViewModel acts as `Listenable` for GoRouter redirect; guards all authenticated routes

### 2. Template Engine Feature (`lib/features/template_engine/`) â€” 44 files
- **Purpose:** Browse, search, and select AI art generation templates
- **Architecture:** data/domain/presentation (Clean Architecture) â€” largest feature
- **Domain entities:** `TemplateModel`, `InputFieldModel`, `GenerationJobModel`, `GenerationOptionsModel` (all freezed)
- **Domain policies:** Template access rules, generation policies
- **Data layer:** `TemplateRepository` (Supabase `templates` table)
- **Presentation:** `HomeScreen` (template grid), `TemplateDetailScreen`, view models, providers, widgets

### 3. Create Feature (`lib/features/create/`) â€” 14 files
- **Purpose:** Text-to-image generation flow â€” prompt input, model selection, aspect ratio, image generation
- **Architecture:** domain/presentation (no separate data layer â€” uses template_engine repos)
- **Domain entities:** `CreateFormState` (freezed)
- **Presentation:** `CreateScreen`, `CreateViewModel`, widgets (prompt input, generation options)
- **Integration:** Calls `generate-image` Supabase Edge Function; performs optimistic credit check before generation

### 4. Credits Feature (`lib/features/credits/`) â€” 16 files
- **Purpose:** Freemium credit system â€” balance tracking, transaction history, ad reward integration
- **Architecture:** data/domain/presentation (Clean Architecture)
- **Domain entities:** `CreditBalance` (freezed), `CreditTransaction` (freezed)
- **Domain interface:** `ICreditRepository`
- **Data layer:** `CreditRepository` â€” Supabase `user_credits`, `credit_transactions`, `ad_views` tables; invokes `reward-ad` Edge Function
- **Presentation:** `CreditBalanceProvider` (stream-based, real-time), `AdRewardProvider`, `InsufficientCreditsSheet`, `PremiumModelSheet`
- **Key behavior:** Balance watched via Supabase real-time stream; ad rewards are atomic (daily limit: 10 ads, 5 credits each)

### 5. Subscription Feature (`lib/features/subscription/`) â€” 13 files
- **Purpose:** RevenueCat in-app purchase integration â€” subscription tiers (Pro/Ultra), paywall, purchase/restore
- **Architecture:** data/domain/presentation (Clean Architecture)
- **Domain entities:** `SubscriptionStatus` (freezed), `SubscriptionPackage` (freezed)
- **Domain interface:** `ISubscriptionRepository`
- **Data layer:** `SubscriptionRepository` â€” wraps RevenueCat SDK (`purchases_flutter`)
- **Presentation:** `SubscriptionNotifier` (AsyncNotifier), `OfferingsProvider`, `PaywallScreen`, `TierComparisonCard`
- **Tiers:** Free (10 welcome credits), Pro (200 credits/month), Ultra (500 credits/month)
- **Key behavior:** RevenueCat webhook updates `profiles` table subscription columns server-side

### 6. Gallery Feature (`lib/features/gallery/`) â€” 26 files
- **Purpose:** View, share, download, and soft-delete generated images
- **Architecture:** data/domain/presentation (Clean Architecture)
- **Domain entities:** `GalleryItem` (freezed)
- **Data layer:** `GalleryRepository` (Supabase `generation_jobs` + Storage)
- **Presentation:** `GalleryPage`, `ImageViewerPage` (full-screen), providers, widgets
- **Extracted widgets:** `ImageInfoBottomSheet`, `ImageViewerAppBar`, `ImageViewerImagePage`, `ImageViewerPageIndicator`, `ImageViewerSwipeDismiss`
- **Key behavior:** Free-tier images display watermark overlay (via `WatermarkUtil`)

### 7. Settings Feature (`lib/features/settings/`) â€” 9 files
- **Purpose:** Theme toggle, account management
- **Architecture:** data/domain/presentation
- **Data layer:** `SharedPreferences`-based persistence
- **Presentation:** `SettingsScreen`
- **Extracted widgets:** `UserProfileCard`, `SettingsSections`, `SettingsHelpers` (6 helper widgets)

### 8. Core Layer (`lib/core/`) â€” 29 files
- **Config:** `EnvConfig` (dotenv loader, validates SUPABASE_URL/ANON_KEY), `SentryConfig`
- **Constants:** `AiModels` (16 AI models across 5 providers â€” sync-validated by Deno tests), `AppConstants` (credits: 5 default, 10 daily ad limit, 5 credits/ad, aspect ratios, categories), `GenerationConstants`
- **Design System:** Animations, Dimensions, Gradients, Shadows, Spacing, Typography
- **Exceptions:** `AppException` (freezed union: network, auth, storage, **payment**, **generation**, unknown)
- **Providers:** Supabase client, Connectivity
- **Services:** `HapticService`, `RewardedAdService` (Google AdMob rewarded interstitials)
- **Utils:** `AppExceptionMapper`, `EmailValidator` â­ NEW, `retry` (exponential backoff), `DateTimeUtils`, `WatermarkUtil`

### 9. Routing (`lib/routing/`)
- **Router:** GoRouter with type-safe route classes (`go_router_builder` codegen)
- **Auth redirect:** Router watches `AuthViewModel` for auth state changes
- **Shell route:** `MainShellRoute` wraps tabbed screens (Home, Create, Gallery, Settings)
- **Transitions:** Custom fade, slide-up, fade-through transitions

### 10. Shared Widgets (`lib/shared/widgets/`) â€” 15 widgets
- `AnimatedRetryButton`, `AppSnackbar`, `AspectRatioSelector`, `ErrorIllustration`, `ErrorPage`, `ErrorStateWidget`, `GradientButton`, `ImageCountDropdown`, `LoadingStateWidget`, `MainShell`, `ModelSelector`, `OfflineBanner`, `OutputFormatToggle`, `SectionHeader`, `WatermarkOverlay`
- All widgets â‰¤250 lines (target met after Widget Cleanup milestone)

### 11. Admin Dashboard (`admin/`)
- **Purpose:** Separate Flutter web app for managing templates, viewing dashboard stats
- **Features:** Auth (admin login), Dashboard (stats overview), Templates (CRUD)
- **Core:** Custom Artio brand theme, NavigationRail shell, GoRouter
- **Backend:** Same Supabase instance; admin RLS policies on `templates` table

### 12. Supabase Edge Functions (`supabase/functions/`)

#### `_shared/` â€” Shared Deno Modules
- `cors.ts` â€” CORS headers helper
- `model_config.ts` â€” `MODEL_CREDIT_COSTS` (16 models), `PREMIUM_MODELS` (7 models), `isPremiumModel()`, `getModelCreditCost()`
- `credit_logic.ts` â€” `checkAndDeductCredits()` (atomic via `deduct_credits` RPC), `refundCreditsOnFailure()` (exponential backoff retry, `[CRITICAL]` log on exhaustion)
- `model_config_test.ts` â€” 8 Deno tests (premium/free validation, cost checks, **exact ID + cost sync** with Dart `ai_models.dart`)
- `credit_logic_test.ts` â€” 7 Deno tests (deduct success/insufficient/error, refund first/retry/exhaust/exception)

#### `generate-image/` â€” AI Image Generation Orchestrator
- **Runtime:** Deno (Supabase Edge Runtime)
- **Flow:** Authenticate user â†’ validate job ownership â†’ **deduct credits** (via `_shared/credit_logic.ts`) â†’ route to AI provider â†’ poll for results â†’ mirror images to Supabase Storage â†’ update job status (refund on failure via `_shared/credit_logic.ts`)
- **Providers:** KIE.ai (Imagen4, Imagen4-Fast, Imagen4-Ultra, Nano-Banana, Flux-2, GPT Image, Seedream) and Gemini (gemini-3-pro-image-preview, gemini-2.5-flash-image)
- **Security:** JWT auth, job ownership verification, service-role key for storage and credit functions

#### `reward-ad/` â€” Rewarded Ad Credit Granting â­ NEW
- **Runtime:** Deno
- **Flow:** Authenticate user via JWT â†’ call `reward_ad_credits` RPC (atomic: validates daily limit, awards 5 credits, logs transaction) â†’ return result
- **Security:** JWT auth; RPC is `SECURITY DEFINER`, revoked from `authenticated` role

#### `revenuecat-webhook/` â€” Subscription Lifecycle
- **Runtime:** Deno (277 lines)
- **Flow:** Verify `REVENUECAT_WEBHOOK_SECRET` (timing-safe comparison) â†’ parse event type â†’ map product ID to tier/credits â†’ call `update_subscription_status` + `grant_subscription_credits` RPCs
- **Events handled:** `INITIAL_PURCHASE`, `RENEWAL`, `CANCELLATION`, `EXPIRATION`, `PRODUCT_CHANGE`, `BILLING_ISSUE`, `SUBSCRIBER_ALIAS`
- **Security:** Webhook secret verification (typed Deno `timingSafeEqual`); all RPCs are `SECURITY DEFINER`, revoked from `authenticated`

---

## Database Schema

| Table | Purpose | RLS |
|-------|---------|-----|
| `profiles` | User profile data (linked to `auth.users`) + subscription columns (`is_premium`, `premium_expires_at`, `subscription_tier`, `revenuecat_app_user_id`) | Users own profile; auto-created via trigger; subscription columns protected by `prevent_premium_self_update` trigger |
| `templates` | AI art generation prompt templates | Public read (active only); admin full access |
| `generation_jobs` | Image generation job tracking | Users own jobs; soft delete (`deleted_at`) |
| `user_credits` | User credit balance (integer, â‰¥ 0) | Users can SELECT own row; mutations via SECURITY DEFINER functions only |
| `credit_transactions` | Credit transaction history (welcome_bonus, ad_reward, generation, refund, subscription, purchase, daily_reset, admin_grant, manual) | Users can SELECT own rows; INSERT via SECURITY DEFINER functions only |
| `ad_views` | Daily ad view counter (max 10/day per user) | Users can SELECT own rows; mutations via `reward_ad_credits` function only |
| **Storage bucket** | `generated-images` (private, 10MB limit, png/jpeg/webp) | Users own folder (`{userId}/`) |

### Database Functions (SECURITY DEFINER)

| Function | Purpose | Callable By |
|----------|---------|-------------|
| `deduct_credits(user_id, amount, description, reference_id)` | Atomically deduct credits (fails if insufficient) | service_role only |
| `refund_credits(user_id, amount, description, reference_id)` | Refund credits (raises exception if no user row) | service_role only |
| `reward_ad_credits(user_id)` | Atomic ad reward: validate daily limit, award 5 credits, log transaction | service_role only |
| `grant_subscription_credits(user_id, amount, description, reference_id)` | Idempotent subscription credit granting (skips duplicate `reference_id`) | service_role only |
| `update_subscription_status(user_id, is_premium, tier, expires_at)` | Update profile subscription columns | service_role only |
| `handle_new_user()` | Signup trigger: create profile + initialize 20 welcome credits | Trigger (automatic) |
| `prevent_premium_self_update()` | Before-update trigger: prevent users from modifying subscription columns | Trigger (automatic) |

---

## Data Flow

### Image Generation Flow
1. **User** selects template or opens Create screen â†’ fills prompt, selects model/aspect-ratio
2. **App** performs optimistic credit check (client-side balance â‰¥ model cost)
3. **App** creates a `generation_job` record (status: `pending`) in Supabase
4. **App** invokes `generate-image` Edge Function with `jobId`, `prompt`, `model`, `aspectRatio`
5. **Edge Function** authenticates user, validates job ownership
6. **Edge Function** calls `deduct_credits` (atomic, fails if insufficient â†’ returns 402)
7. **Edge Function** routes to AI provider:
   - **KIE.ai:** `createTask` â†’ poll `getTaskDetail` until completed â†’ download image URLs
   - **Gemini:** `generateContent` â†’ extract base64 images
8. **Edge Function** mirrors images to `generated-images` Storage bucket
9. **Edge Function** updates `generation_jobs` (status: `completed`, `result_urls`)
10. **On failure:** Edge Function calls `refund_credits` to restore deducted amount
11. **App** polls/watches job status, displays results in Gallery

### Credit & Monetization Flow
1. **New user signup** â†’ `handle_new_user()` trigger grants 20 welcome credits
2. **Ad rewards** â†’ User watches rewarded ad â†’ app calls `reward-ad` Edge Function â†’ `reward_ad_credits` RPC awards 5 credits (max 10 ads/day)
3. **Subscription purchase** â†’ RevenueCat SDK handles payment â†’ webhook calls `grant_subscription_credits` + `update_subscription_status`
4. **Subscription renewal** â†’ Same webhook flow, idempotent via `reference_id`
5. **Free-tier images** â†’ `WatermarkOverlay` applied in gallery viewer

### Auth Flow
1. **App start** â†’ `SplashScreen` checks session via Supabase Auth
2. **GoRouter redirect** watches `AuthViewModel` â†’ routes to Login or Home
3. **Registration** triggers `handle_new_user()` DB trigger â†’ auto-creates `profiles` row + 20 welcome credits

---

## Integration Points

| Service | Type | Purpose | Status |
|---------|------|---------|--------|
| **Supabase** | BaaS | Auth, Postgres DB, Storage, Edge Functions | âœ… Active |
| **KIE.ai** | API (REST) | AI image generation (Imagen4, Flux-2, GPT Image, Seedream) | âœ… Active |
| **Google Gemini** | API (REST) | AI image generation (gemini-3-pro, gemini-2.5-flash) | âœ… Active |
| **Sentry** | SaaS | Error tracking and monitoring | âœ… Active |
| **RevenueCat** | SDK | In-app purchases (iOS/Android) â€” Pro/Ultra tiers | âœ… Implemented |
| **Google AdMob** | SDK | Mobile rewarded ads (5 credits/ad, 10 ads/day) | âœ… Implemented |
| **Stripe** | SDK | Web payments | ğŸ”œ Planned |

---

## Technical Debt

- [x] ~~**KIE vs app model mismatch**~~ â€” Fixed: `_shared/model_config.ts` + exact ID/cost sync tests validate all 16 models match `ai_models.dart`
- [ ] **No caching layer** â€” Templates and gallery items fetched fresh each time; no local persistence
- [ ] **Admin dashboard not connected as monorepo** â€” separate pubspec, no shared code with main app
- [ ] **Integration tests require real Supabase** â€” `.env.test` with live credentials needed
- [ ] **Soft delete not fully propagated** â€” `deleted_at` on `generation_jobs` but no archive/restore UI
- [ ] **`public_member_api_docs` disabled** â€” no public API docs requirement (acceptable for MVP)
- [x] ~~**Files over 250-line target**~~ â€” All files now â‰¤250 lines (fixed in Widget Cleanup milestone). 12 files in 200â€“235 range.
- [ ] **AdMob uses placeholder production IDs** â€” `rewarded_ad_service.dart` has `ca-app-pub-XXXXX` placeholders; `kReleaseMode` gate protects debug builds
- [ ] **No Stripe web payment integration** â€” dependency not present; listed as backlog
- [ ] **No subscription management settings page** â€” cancellation/change tier handled outside app (via App Store/Play Store)
- [ ] **No credit history/transaction log UI** â€” backend supports it but no screen built yet
- [x] ~~**Deprecated Riverpod Ref types**~~ â€” Fixed in Code Health milestone
- [x] ~~**Admin web dart:io usage**~~ â€” Fixed in Code Health milestone
- [x] ~~**imagePickerProvider dead code**~~ â€” Removed in Tech Debt Cleanup milestone (0 external imports)
- [x] ~~**revenuecat-webhook timingSafeEqual type error**~~ â€” Fixed with typed Deno cast; now included in `deno task check`
- [ ] ğŸŸ¢ **Sentry/monitoring alert rule** â€” Docs ready (`.gsd/phases/phase-4/SENTRY-ALERTS.md`), needs Supabase Log Drain setup
- [ ] ğŸŸ¢ **`credit_logic.ts` uses `any` type** â€” Pragmatic; fix when Supabase SDK exposes better types

---

## Conventions

**Naming:**
- Feature directories: snake_case (`template_engine`, `gallery`, `credits`, `subscription`)
- Dart files: snake_case
- Classes: PascalCase
- Freezed models: `*_model.dart` or domain entity names â†’ generates `*.freezed.dart` + `*.g.dart`
- Riverpod providers: `@riverpod` annotation â†’ generates `*.g.dart`

**Architecture:**
- Clean Architecture per feature: `data/` â†’ `domain/` â†’ `presentation/`
- Some lightweight features omit `data/` (create) or `domain/` (settings)
- State management: Riverpod with code generation (`riverpod_annotation` + `riverpod_generator`)
- Data classes: Freezed + json_serializable
- Routing: GoRouter with `go_router_builder` type-safe routes
- Repository pattern: Interface in `domain/repositories/`, implementation in `data/repositories/`

**Error Handling:**
- `AppException` freezed union type with 6 variants: `network`, `auth`, `storage`, `payment`, `generation`, `unknown`
- `AppExceptionMapper` translates raw errors to domain exceptions
- `retry` utility with exponential backoff for transient failures

**Testing:**
- Test structure mirrors `lib/` (`test/core/`, `test/features/`)
- **Flutter:** 76 unit/widget test files, 5 integration test files
- **Deno:** 2 test files (15 tests) via `deno task test`
- Mocking: `mocktail` (primary) + `mockito`
- Test fixtures in `test/core/fixtures/`
- Integration tests in `integration_test/`
- Lint: `very_good_analysis` (strict)
- Static analysis: `flutter analyze` â€” 1 warning (`prefer_const_declarations` in test file, non-blocking)
- Deno type-check: `deno task check` â€” 5 files, 0 issues âœ…

**File Size:**
- Target: â‰¤ 250 lines per file âœ… (all files within target; 12 files in 200â€“235 range)

**Environment:**
- Multi-env support: `.env.development`, `.env.staging`, `.env` (production)
- Build-time flag: `--dart-define=ENV=development`
