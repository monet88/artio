# Architecture

> Auto-generated by /map on 2026-02-17

## Overview

**Artio** is an AI-powered art generation mobile app built with Flutter and backed by Supabase. Users browse curated prompt templates, customize parameters, generate images via AI APIs (KIE.ai and Google Gemini), and manage their personal gallery. The project is a monorepo containing both the **mobile client app** and a **web admin dashboard**.

```
┌──────────────────────────────────────────────────────┐
│              Flutter Mobile App (artio/)              │
│  Splash → Auth → Shell (Home / Create / Gallery / Settings)  │
├──────────────────────────────────────────────────────┤
│          Feature Modules (Clean Architecture)        │
│  auth • template_engine • create • gallery • settings│
├──────────────────────────────────────────────────────┤
│       Core Layer (Config, Providers, Design System)  │
├──────────────────────────────────────────────────────┤
│              Supabase (Auth + DB + Storage)           │
│              Edge Function (generate-image)           │
│              AI Providers (KIE.ai + Gemini)           │
└──────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────┐
│          Flutter Web Admin (admin/)                  │
│  Auth → Shell (Dashboard / Templates)                │
└──────────────────────────────────────────────────────┘
```

---

## Project Structure

```
artio/
├── lib/                      # Main app source code
│   ├── main.dart             # Entry point, Supabase init, Sentry
│   ├── core/                 # Shared infrastructure
│   │   ├── config/           # EnvConfig, SentryConfig
│   │   ├── constants/        # AiModels, AppConstants, GenerationConstants
│   │   ├── design_system/    # Animations, Dimensions, Gradients, Shadows, Spacing, Typography
│   │   ├── exceptions/       # AppException (freezed)
│   │   ├── providers/        # Connectivity, Supabase providers
│   │   ├── services/         # HapticService
│   │   ├── state/            # UserScopedProviders
│   │   └── utils/            # AppExceptionMapper, Retry, CodegenSmoke
│   ├── features/             # Feature modules (Clean Architecture)
│   │   ├── auth/             # Authentication (data/domain/presentation)
│   │   ├── template_engine/  # Template browsing & detail (data/domain/presentation)
│   │   ├── create/           # Text-to-image generation (domain/presentation)
│   │   ├── gallery/          # User image gallery (data/domain/presentation)
│   │   └── settings/         # App settings (data/presentation)
│   ├── routing/              # GoRouter with type-safe routes
│   ├── shared/widgets/       # Reusable widgets (snackbar, error states, model selector, etc.)
│   ├── theme/                # AppTheme, AppColors, ThemeProvider
│   └── utils/                # LoggerService
├── admin/                    # Admin dashboard (separate Flutter web app)
│   └── lib/
│       ├── core/             # Router, theme, constants, utils, shell
│       ├── features/         # auth, dashboard, templates
│       └── shared/           # Shared admin widgets
├── supabase/
│   ├── migrations/           # 5 SQL migrations
│   └── functions/
│       └── generate-image/   # Deno Edge Function (TypeScript)
├── test/                     # Unit + widget tests (mirrors lib/ structure)
├── integration_test/         # E2E tests (auth, gallery, generation, settings, template)
├── docs/                     # Project docs, KIE API docs, architecture
├── scripts/                  # Validation & search scripts (PowerShell + Bash)
└── android/ ios/ web/ windows/  # Platform shells
```

---

## Components

### 1. Auth Feature (`lib/features/auth/`)
- **Purpose:** User registration, login, password reset, session management
- **Architecture:** data/domain/presentation (Clean Architecture)
- **Domain entities:** `UserModel` (freezed)
- **Data layer:** `AuthRepository` (Supabase Auth)
- **Presentation:** `AuthViewModel` (Riverpod), `SplashScreen`, `LoginScreen`, `RegisterScreen`, `ForgotPasswordScreen`
- **Key behavior:** AuthViewModel acts as `Listenable` for GoRouter redirect; guards all authenticated routes

### 2. Template Engine Feature (`lib/features/template_engine/`)
- **Purpose:** Browse, search, and select AI art generation templates
- **Architecture:** data/domain/presentation (Clean Architecture) — largest feature (~37 files)
- **Domain entities:** `TemplateModel`, `InputFieldModel`, `GenerationJobModel`, `GenerationOptionsModel` (all freezed)
- **Domain policies:** Template access rules, generation policies
- **Data layer:** `TemplateRepository` (Supabase `templates` table)
- **Presentation:** `HomeScreen` (template grid), `TemplateDetailScreen`, view models, providers, widgets

### 3. Create Feature (`lib/features/create/`)
- **Purpose:** Text-to-image generation flow — prompt input, model selection, aspect ratio, image generation
- **Architecture:** domain/presentation (no separate data layer — uses template_engine repos)
- **Domain entities:** `CreateFormState` (freezed)
- **Presentation:** `CreateScreen`, `CreateViewModel`, widgets (prompt input, generation options)
- **Integration:** Calls `generate-image` Supabase Edge Function

### 4. Gallery Feature (`lib/features/gallery/`)
- **Purpose:** View, share, download, and soft-delete generated images
- **Architecture:** data/domain/presentation (Clean Architecture)
- **Domain entities:** `GalleryItem` (freezed)
- **Data layer:** `GalleryRepository` (Supabase `generation_jobs` + Storage)
- **Presentation:** `GalleryPage`, `ImageViewerPage` (full-screen), providers, widgets

### 5. Settings Feature (`lib/features/settings/`)
- **Purpose:** Theme toggle, account management
- **Architecture:** data/presentation (lightweight)
- **Data layer:** `SharedPreferences`-based persistence
- **Presentation:** `SettingsScreen`

### 6. Core Layer (`lib/core/`)
- **Config:** `EnvConfig` (dotenv loader, validates SUPABASE_URL/ANON_KEY), `SentryConfig`
- **Constants:** `AiModels` (13 AI models across 4 providers — Imagen, Flux-2, GPT Image, Seedream), `AppConstants`, `GenerationConstants`
- **Design System:** Animations, Dimensions, Gradients, Shadows, Spacing, Typography
- **Exceptions:** `AppException` (freezed union type: network, server, auth, timeout, validation, unknown)
- **Providers:** Supabase client, Connectivity
- **Utils:** `AppExceptionMapper` (translates raw errors to `AppException`), `retry` (exponential backoff)

### 7. Routing (`lib/routing/`)
- **Router:** GoRouter with type-safe route classes (`go_router_builder` codegen)
- **Auth redirect:** Router watches `AuthViewModel` for auth state changes
- **Shell route:** `MainShellRoute` wraps tabbed screens (Home, Create, Gallery, Settings)
- **Transitions:** Custom fade, slide-up, fade-through transitions

### 8. Shared Widgets (`lib/shared/widgets/`)
- 11 reusable widgets: `AppSnackbar`, `AspectRatioSelector`, `ErrorPage`, `ErrorStateWidget`, `ImageCountDropdown`, `LoadingStateWidget`, `MainShell`, `ModelSelector`, `OfflineBanner`, `OutputFormatToggle`, `SectionHeader`

### 9. Admin Dashboard (`admin/`)
- **Purpose:** Separate Flutter web app for managing templates, viewing dashboard stats
- **Features:** Auth (admin login), Dashboard (stats overview), Templates (CRUD)
- **Core:** Custom Artio brand theme, NavigationRail shell, GoRouter
- **Backend:** Same Supabase instance; admin RLS policies on `templates` table

### 10. Supabase Edge Function (`supabase/functions/generate-image/`)
- **Purpose:** Server-side image generation orchestrator
- **Runtime:** Deno (Supabase Edge Runtime)
- **Flow:** Authenticate user → validate job ownership → route to AI provider → poll for results → mirror images to Supabase Storage → update job status
- **Providers:** KIE.ai (Imagen4, Imagen4-Fast, Imagen4-Ultra, Nano-Banana) and Gemini (gemini-3-pro-image-preview, gemini-2.5-flash-image)
- **Security:** JWT auth, job ownership verification, service-role key for storage

---

## Database Schema

| Table | Purpose | RLS |
|-------|---------|-----|
| `profiles` | User profile data (linked to `auth.users`) | Users own profile; auto-created via trigger |
| `templates` | AI art generation prompt templates | Public read (active only); admin full access |
| `generation_jobs` | Image generation job tracking | Users own jobs; soft delete (`deleted_at`) |
| **Storage bucket** | `generated-images` (private, 10MB limit, png/jpeg/webp) | Users own folder (`{userId}/`) |

---

## Data Flow

### Image Generation Flow
1. **User** selects template or opens Create screen → fills prompt, selects model/aspect-ratio
2. **App** creates a `generation_job` record (status: `pending`) in Supabase
3. **App** invokes `generate-image` Edge Function with `jobId`, `prompt`, `model`, `aspectRatio`
4. **Edge Function** authenticates user, validates job ownership
5. **Edge Function** routes to AI provider:
   - **KIE.ai:** `createTask` → poll `getTaskDetail` until completed → download image URLs
   - **Gemini:** `generateContent` → extract base64 images
6. **Edge Function** mirrors images to `generated-images` Storage bucket
7. **Edge Function** updates `generation_jobs` (status: `completed`, `result_urls`)
8. **App** polls/watches job status, displays results in Gallery

### Auth Flow
1. **App start** → `SplashScreen` checks session via Supabase Auth
2. **GoRouter redirect** watches `AuthViewModel` → routes to Login or Home
3. **Registration** triggers `handle_new_user()` DB trigger → auto-creates `profiles` row

---

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| **Supabase** | BaaS | Auth, Postgres DB, Storage, Edge Functions |
| **KIE.ai** | API (REST) | AI image generation (Imagen4, Flux-2, GPT Image, Seedream) |
| **Google Gemini** | API (REST) | AI image generation (gemini-3-pro, gemini-2.5-flash) |
| **Sentry** | SaaS | Error tracking and monitoring |
| **RevenueCat** | SDK | In-app purchases (iOS/Android) — planned |
| **Stripe** | SDK | Web payments — planned |
| **Google AdMob** | SDK | Mobile ads — planned |

---

## Technical Debt

- [ ] **No credit/billing system yet** — `creditCost` defined on models but no usage tracking or enforcement
- [ ] **RevenueCat/Stripe/AdMob not implemented** — dependencies present in pubspec but not wired up
- [ ] **KIE vs app model mismatch** — Edge Function hardcodes certain model lists; some models (Flux-2, Seedream) defined in app constants but not registered in Edge Function
- [ ] **No caching layer** — Templates and gallery items fetched fresh each time; no local persistence
- [ ] **Admin dashboard not connected as monorepo** — separate pubspec, no shared code with main app
- [ ] **Missing test coverage for Create feature** — only 4 test files in `test/features/create/`
- [ ] **Integration tests require real Supabase** — `.env.test` with live credentials needed
- [ ] **Soft delete not fully propagated** — `deleted_at` on `generation_jobs` but no archive/restore UI
- [ ] **`public_member_api_docs` disabled** — no public API docs requirement (acceptable for MVP)

---

## Conventions

**Naming:**
- Feature directories: snake_case (`template_engine`, `gallery`)
- Dart files: snake_case
- Classes: PascalCase
- Freezed models: `*_model.dart` → generates `*.freezed.dart` + `*.g.dart`
- Riverpod providers: `@riverpod` annotation → generates `*.g.dart`

**Architecture:**
- Clean Architecture per feature: `data/` → `domain/` → `presentation/`
- Some lightweight features omit `data/` (create) or `domain/` (settings)
- State management: Riverpod with code generation (`riverpod_annotation` + `riverpod_generator`)
- Data classes: Freezed + json_serializable
- Routing: GoRouter with `go_router_builder` type-safe routes

**Testing:**
- Test structure mirrors `lib/` (`test/core/`, `test/features/`)
- Mocking: `mocktail` (primary) + `mockito`
- Test fixtures in `test/core/fixtures/`
- Integration tests in `integration_test/`
- Lint: `very_good_analysis` (strict)

**Environment:**
- Multi-env support: `.env.development`, `.env.staging`, `.env` (production)
- Build-time flag: `--dart-define=ENV=development`
